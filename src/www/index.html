<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <title>Giant Parrot Citation Graph</title>
    <style>
      * { margin: 0; padding: 0; user-select: none; }
      body { height: 100vh; }
    </style>
    <link rel="stylesheet" href="styles.css">

    <script defer src="https://d3js.org/d3.v5.min.js"></script>
  </head>

  <body onload=start()>

    <!-- UI layout -->
    <svg onclick="draw()"></svg>

    <script type="module">
      export default class Tree {

        constructor(rootID) {
          this.rootID = rootID;
          this.children = [];
        }

        getData() {
          return {
            data: { name: this.rootID, id: this.rootID },
            children: this.children.map(tree => tree.getData())
          }
        }


        KillYourChildren() {
          this.children = [];
        }

        getSubTree(id) {
          if (this.rootID === id)
            return this;

          for (let child of this.children) {
            let tree = child.getSubTree(id);
            if (tree != null)
              return tree;
          }
          return null;
        }

        AddRelation(parent, child) {
          this.children.push(new Tree(child));
        }
      }
      window.Tree = Tree;
    </script>
    <script type="module">
      window.dat = {
        name: 1,
        children: [
          {
            name: 2, children: [
              {name: 5, children: [{name: 7, children: []}]},
              {name: 6, children: [{name: 10, children: []}]}
            ]
          },
          {
            name: 3, children: [
              {name: 6, children: [{name: 10, children: []}]}
            ]
          },
          {
            name: 4,
            children: [
              {name: 8, children: [{name: 9, children: []}]}

            ]
          },
          {name: 6, children: [{name: 10, children: []}]}
        ]
      }
    </script>
    <!-- Connect UI actions to Go functions -->
    <script>

      let appSize = { width: 300, height: 300 }; /* Defaults */
      let svg;

      function init(size) {
        appSize = size;
        let svg = d3.select("svg")
                .style("width", appSize.width)
                .style("height", appSize.height);

        console.log("init js processing.", size, dat);
      }

      /**
       * Draw the visualization
       */
      function draw() {
        let svg = d3.select("svg")
          .style("width", appSize.width)
          .style("height", appSize.height);

        let nodes = svg.append('g').attr('class', 'nodes').attr("transform", "translate(0," + 10 + ")");
        let links = svg.append('g').attr('class', 'links').attr("transform", "translate(0," + 10 + ")");

        let tree = new Tree(1);
        let root = d3.hierarchy(window.dat);
        let treeLayout = d3.tree();
        treeLayout.size([appSize.width - 20, appSize.height - 20]);
        treeLayout(root);

        nodes.selectAll("*").remove();
        links.selectAll("*").remove();

          // Nodes
        nodes.selectAll('circle.node')
            .data(root.descendants())
            .enter()
            .append('circle')
            .classed('node', true)
            .on("click", d => open(d.data.data.id))
            .on("contextmenu", function (d, i) {
              d3.event.preventDefault();
              tree.getSubTree(d.data.data.id).KillYourChildren();
              drawD3Tree(tree);
            })
            .attr('cx', d => d.x).attr('cy', d => d.y)
            .attr('r', 4);

          // Links
        links.selectAll('line.link')
            .data(root.links())
            .enter()
            .append('line')
            .classed('link', true)
            .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x).attr('y2', d => d.target.y);


        console.log("end of draw call")
      }
    </script>
  </body>
</html>
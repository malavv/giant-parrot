<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <title>Giant Parrot Citation Graph</title>
    <style>
      * { margin: 0; padding: 0; user-select: none; }
      body { height: 100vh; }
    </style>
    <link rel="stylesheet" href="styles.css">

    <script defer src="//d3js.org/d3.v3.js"></script>
    <script defer src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  </head>

  <body onload=start()>

    <!-- UI layout -->
    <svg onclick="draw()"></svg>

    <script type="module">
      window.dag = {
        "nodes": [
          { "id": 0, "name": "node-0" }, // 0
          { "id": 1, "name": "node-1" }, // 1
          { "id": 2, "name": "node-2" }, // 2
          { "id": 3, "name": "node-3" }, // 3
          { "id": 4, "name": "node-4" }, // 4
          { "id": 5, "name": "node-5" }, // 5
          { "id": 6, "name": "node-6" }, // 6
          { "id": 7, "name": "node-7" }, // 7
          { "id": 8, "name": "node-8" }, // 8
          { "id": 9, "name": "node-9" }  // 9
        ],
        "links": [
          { "source": 0, "target": 1 },
          { "source": 0, "target": 2 },
          { "source": 0, "target": 3 },
          { "source": 0, "target": 5 },
          { "source": 1, "target": 4 },
          { "source": 1, "target": 5 },
          { "source": 2, "target": 5 },
          { "source": 3, "target": 7 },
          { "source": 4, "target": 6 },
          { "source": 5, "target": 9 },
          { "source": 7, "target": 8 }
        ]
      };
    </script>
    <!-- Connect UI actions to Go functions -->
    <script>
      const radius = 6;

      let appSize = { width: 300, height: 300 }; /* Defaults */
      let svg;
      let link, node;

      let tooltip;
      let fill;
      let force;

      let le, ne;

      let tip;

      function init(size) {
        appSize = size;
        fill = d3.scale.category20();
        svg = d3.select("svg")
                .style("width", appSize.width)
                .style("height", appSize.height);
        force = d3.layout.force()
                .charge(-120)
                .linkDistance(30)
                .size([appSize.width - 20, appSize.height - 20])
                .on("tick", tick);

        le = svg.selectAll(".link");
        ne = svg.selectAll(".node");

        tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(d => `<strong>Title:</strong> <span style='color:red'>${d.name}</span>`);

        svg.call(tip);

        console.log("end of js initialization");
      }

      /**
       * Draw the visualization
       */
      function draw() {
        force.nodes(dag.nodes)
             .links(dag.links)
             .start();

        // Update links.
        le = le.data(dag.links, d => `${d.source.id},${d.target.id}`);
        le.exit().remove();
        le.enter()
            .insert("line", ".node")
            .attr("class", "link");

        // Update nodes
        ne = ne.data(dag.nodes, d => d.id);
        ne.exit().remove();
        let nodeEnter = ne.enter().append("g")
                .attr("class", "node")
                .on("click", click);
        nodeEnter.append("circle")
                .attr("r", radius - .75)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide);

        console.log("end of draw call");
      }

      // On node click collapsible
      function click(d) {
        if (d3.event.defaultPrevented) return; // ignore drag

        if (!dat.unusedLinks) dat.unusedLinks = [];
        dag.links.filter(lk => lk.source.id === d.id).forEach(lk => dat.unusedLinks.push(lk));
        dag.links = dag.links.filter(lk => lk.source.id !== d.id);

        draw();
      }

      // On every simulation ticks
      function tick(e) {
        // Apply constraint (Push sources up and targets down to form a weak tree)
        const k = 6 * e.alpha;
        le.each(d => { d.source.y -= k; d.target.y += k; });

        // Draw nodes and links
        le.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        ne.attr('transform', d => `translate(${d.x}, ${d.y})`);
      }

    </script>
  </body>
</html>
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <title>Giant Parrot Citation Graph</title>
    <style>
      * { margin: 0; padding: 0; user-select: none; }
      body { height: 100vh; }
    </style>
    <link rel="stylesheet" href="styles.css">

    <script defer src="//d3js.org/d3.v3.js"></script>
    <script defer src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  </head>

  <body onload=start()>

    <!-- UI layout -->
    <svg onclick="draw()"></svg>

    <script src="data.js"></script>

    <!-- Connect UI actions to Go functions -->
    <script>
      const radius = 6;

      let appSize = { width: 300, height: 300 }; /* Defaults */
      let svg;
      let link, node;
      const rootID = "16479230";
      let tooltip;
      let fill;
      let force;

      let le, ne;

      let tip;

      function init(size) {
        appSize = size;
        fill = d3.scale.category20();
        svg = d3.select("svg")
                .style("width", appSize.width)
                .style("height", appSize.height);
        force = d3.layout.force()
                .charge(-120)
                .linkDistance(30)
                .size([appSize.width - 20, appSize.height - 20])
                .on("tick", tick);

        le = svg.selectAll(".link");
        ne = svg.selectAll(".node");

        tip = d3.tip()
                .attr('class', 'd3-tip')
                //.offset([-10, 0])
                .direction(d => d.y < appSize.height / 2 ? 's' : 'n')
                .html(d => `<strong>Title:</strong> <span style='color:red'>${d.title}</span>`);

        svg.call(tip);

        console.log("end of js initialization");
      }

      /**
       * Draw the visualization
       */
      function draw() {
        force.nodes(dag.nodes)
             .links(dag.links)
             .start();

        // Update links.
        le = le.data(dag.links, d => `${d.source.PMID},${d.target.PMID}`);
        le.exit().remove();
        le.enter()
            .insert("line", ".node")
            .attr("class", "link");

        // Update nodes
        ne = ne.data(dag.nodes, d => d.PMID);
        ne.exit().remove();
        let nodeEnter = ne.enter().append("g")
                .attr("class", d => d.PMID === rootID ? 'node root': 'node')
                .on('contextmenu', d => {
                  d3.event.preventDefault();

                  window.open(`https://www.ncbi.nlm.nih.gov/pubmed/${d.PMID}`, '_blank');
                })
                .on("click", click);

        nodeEnter.append("circle")
                .attr("r", radius - .75)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide);

        console.log("end of draw call");
      }

      // On node click collapsible
      function click(d) {
        if (d3.event.defaultPrevented) return; // ignore drag

        if (!dag.unusedLinks) dag.unusedLinks = [];
        dag.links.filter(lk => lk.source.PMID === d.PMID).forEach(lk => dag.unusedLinks.push(lk));
        dag.links = dag.links.filter(lk => lk.source.PMID !== d.PMID);

        draw();
      }

      // On every simulation ticks
      function tick(e) {
        // Apply constraint (Push sources up and targets down to form a weak tree)
        const k = 6 * e.alpha;
        le.each(d => { d.source.y -= k; d.target.y += k; });

        // Apply constraint 2 (within the view space)
        ne.attr("cx", d => d.x = Math.max(radius, Math.min(appSize.width - radius, d.x)))
          .attr("cy", d => d.y = Math.max(radius, Math.min(appSize.height - radius, d.y)));

        // Draw nodes and links
        le.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        ne.attr('transform', d => `translate(${d.x}, ${d.y})`);
      }

    </script>
  </body>
</html>